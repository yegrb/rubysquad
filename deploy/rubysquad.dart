import "dart:html" as h;import "dart:json" as FD;class GD{static const  HD="Chrome";static const  ID="Firefox";static const  JD="Internet Explorer";static const  KD="Safari";final  qC;final  minimumVersion;const GD(this.qC,[this.minimumVersion]);}class LD{final  name;const LD(this.name);}class hB{var canvas;var j;var OD;var PD;var QD;hB(){RD();SD();TD();} SD(){canvas=h.query(".game-canvas");var i=canvas.context2D;j=new p(canvas);j.IB=( l){};j.HB=(( g){});} TD(){OD=new h.WebSocket("ws://${QD}:${PD}/ws");} RD(){PD=int.parse(h.window.location.port);if(PD==3030){PD=3000;}QD=h.window.location.hostname;} start(){j.start();OD.onMessage.listen(( i){var g=i.data;var l=g.split(":").first;switch (l){case 'pong':h.query(".msg").text="Received pong!";break;case 'reply':var o=FD.parse(g.substring(g.indexOf(":")+1));h.query(".msg").text="Received reply! data = ${o}";break;}});OD.onOpen.listen((UD){OD.send("echo:${FD.stringify({"name":"Bob Barker","power_level":1000})}");});}} main(){var g=new hB();g.start();}abstract class RB{ get x; get y; get dx; get dy; get time; get k;}class SB{final  q;var bB=0;var cB=0;var zC=0.0;var AD=0.0;SB(this.q); get s=>bB>cB;}typedef  iB( gameLoop);abstract class m{var t=0.015;var GB=0.03; get k; get dB; get rC=>t;static  CB(g)=>g/1000.0; get time=>CB(new DateTime.now().millisecondsSinceEpoch);m(){} wC(){var VD=WD.length;for(int g=0;g<VD;g++ ){WD[g].XD(rC);}for(int g=WD.length-1;g>=0;g-- ){var i=WD.length-1;if(WD[g].YD){if(g!=i){WD[g]=WD[i];}WD.removeLast();}}} start();final  WD=new List<jB>();var IB;}class jB{jB();}class kB{kB();}class TB{final  s;final  k;final  q;final  time;TB(this.q,this.s,this.k,this.time); toString()=>'Button: ${q} DOWN: ${s} [${k}@${time}]';}class DB{final  j;final  buttons=new Map<int,SB>();DB(this.j, i){for(int g in i){buttons[g]=new SB(g);}} aB( i){var g=buttons[i.q];if(g==null){return;}if(i.s){if(g.s==false){g.bB=i.k;g.zC=i.time;}}else{g.cB=i.k;g.AD=i.time;}}}class mB{final  x;final  y;final  dx;final  dy;final  EB;final  FB;final  time;final  JB;final  k;mB(this.x,this.y,this.dx,this.dy,this.EB,this.FB,this.JB,this.time,this.k);}class lB{final  j;lB(this.j){j.element.onClick.listen(ZD);h.document.onPointerLockChange.listen(aD);} xC(){j.element.requestPointerLock();} ZD( g){if(tC){xC();}}var tC=true; aD( g){if(j.onPointerLockChange!=null){j.onPointerLockChange(j);}}}class n{static const UB=0x1;static const VB=0x2;static const WB=0x3;final  event;final  type;n(this.event,this.type);}class nB{final  j;var buttons;var ND;nB(this.j){}}typedef  oB( gameLoop);class pB extends DB{static const qB=h.KeyCode.A;static const sB=h.KeyCode.B;static const tB=h.KeyCode.C;static const uB=h.KeyCode.D;static const wB=h.KeyCode.E;static const xB=h.KeyCode.F;static const yB=h.KeyCode.G;static const AC=h.KeyCode.H;static const BC=h.KeyCode.I;static const DC=h.KeyCode.J;static const FC=h.KeyCode.K;static const HC=h.KeyCode.L;static const JC=h.KeyCode.M;static const LC=h.KeyCode.N;static const MC=h.KeyCode.O;static const NC=h.KeyCode.P;static const OC=h.KeyCode.Q;static const PC=h.KeyCode.R;static const QC=h.KeyCode.S;static const RC=h.KeyCode.T;static const SC=h.KeyCode.U;static const TC=h.KeyCode.V;static const UC=h.KeyCode.W;static const VC=h.KeyCode.X;static const WC=h.KeyCode.Y;static const XC=h.KeyCode.Z;static const YC=h.KeyCode.SHIFT;static const ZC=h.KeyCode.CTRL;static const aC=h.KeyCode.ALT;static const bC=h.KeyCode.SPACE;static const cC=h.KeyCode.ZERO;static const dC=h.KeyCode.ONE;static const eC=h.KeyCode.TWO;static const fC=h.KeyCode.THREE;static const gC=h.KeyCode.FOUR;static const hC=h.KeyCode.FIVE;static const iC=h.KeyCode.SIX;static const jC=h.KeyCode.SEVEN;static const kC=h.KeyCode.EIGHT;static const lC=h.KeyCode.NINE;static const mC=h.KeyCode.TILDE;static const nC=h.KeyCode.ENTER;static const oC=h.KeyCode.UP;static const pC=h.KeyCode.DOWN;static const CC=h.KeyCode.LEFT;static const GC=h.KeyCode.RIGHT;static final  IC=[qB,sB,tB,uB,wB,xB,yB,AC,BC,DC,FC,HC,JC,LC,MC,NC,OC,PC,QC,RC,SC,TC,UC,VC,WC,XC,YC,ZC,aC,bC,cC,dC,eC,fC,gC,hC,iC,jC,kC,lC,mC,nC,oC,pC,CC,GC];pB(g):super(g,IC);}typedef  rB( gameLoop);class XB implements RB{final  x;final  y;final  dx;final  dy;final  time;final  k;XB(this.x,this.y,this.dx,this.dy,this.time,this.k);}typedef  vB( gameLoop);typedef  zB( gameLoop);class YB extends DB implements RB{static const CC=0;static const EC=1;static const GC=2;static final  IC=[CC,EC,GC];var dD=0; get dx=>dD;var hD=0; get dy=>hD;var lD=0; get x=>lD;var mD=0; get y=>mD;var nD=0; get EB=>nD;var qD=0; get FB=>qD;var rD=0;var uD=0;var wD=false; get JB=>wD;var yD=0.0; get time=>yD;var AE=0; get k=>AE;YB(g):super(g,IC); sC( g){lD=g.x;mD=g.y;yD=g.time;AE=g.k;dD+= g.dx;hD+= g.dy;nD=g.EB;qD=g.FB;wD=g.JB;} FE( i, g){rD+= i;uD+= g;} HE(){rD=0;uD=0;dD=0;hD=0;}}typedef  ZB( gameLoop, touch);class u{final  id;final  vC=new List<XB>();u(this.id);}class p extends m{final  element;var bD=0;var cD=false;var eD=false;var fD;var gD=0.0;var iD=false;var jD=0.0; get k=>bD;var GB=0.03;var oD=0.0; get width=>element.client.width; get height=>element.client.height;var sD=0.0; get dB=>sD;var tD=0.0;var yC=0.05;var xD;var zD;var BE; get uC=>BE;var CE;var EE;p(this.element):super(){zD=new pB(this);BE=new YB(this);CE=new nB(this);xD=new lB(this);EE=new KC(this);} GE(){for(h.KeyboardEvent KB in IE){var i;var LB=KB.type=="keydown";var l=m.CB(KB.timeStamp);var MB=KB.keyCode;i=new TB(MB,LB,k,l);zD.aB(i);}IE.clear();uC.HE();var NB=element.offset.left;var OB=element.offset.top;for(h.MouseEvent g in JE){var BD=g.type=='mousemove';var CD=g.type=='mousewheel';var LB=g.type=='mousedown';var l=m.CB(g.timeStamp);if(BD){var PB=g.page.x;var QB=g.page.y;var eB=PB-NB;var fB=QB-OB;var w=0;var o=0;var AB=false;if(PB<NB){w=0;}else if(PB>NB+width){w=width;}else{w=eB;AB=true;}if(QB<OB){o=0;AB=false;}else if(QB>OB+height){o=height;AB=false;}else{o=fB;}var DD=g.movement.x;var ED=g.movement.y;var i=new mB(eB,fB,DD,ED,w,o,AB,l,k);BE.sC(i);}else if(CD){var gB=g as h.WheelEvent;BE.FE(gB.deltaX,gB.deltaY);}else{var MB=g.button;var i=new TB(MB,LB,k,l);BE.aB(i);}}JE.clear();for(n BB in KE){switch (BB.type){case n.WB:EE.pD(BB.event);break;case n.VB:EE.vD(BB.event);break;case n.UB:EE.DE(BB.event);break;default:throw new StateError('Invalid _GameLoopTouchEven type.');}}KE.clear();}var LE; ME( NE){if(fD==null){gD=time;fD=gD;GE();LE=h.window.requestAnimationFrame(ME);return;}if(eD==true){LE=null;return;}LE=h.window.requestAnimationFrame(ME);bD++ ;fD=gD;gD=time;var g=gD-fD;oD+= g;if(oD>GB){oD=GB;}GE();while (oD>=t){wC();sD+= t;if(IB!=null){IB(this);}oD-= t;}if(iD==true&&onResize!=null&&jD<=gD){onResize(this);jD=gD+yC;iD=false;}if(HB!=null){tD=oD/t;HB(this);}} OE( NE){if(onFullscreenChange==null){return;}onFullscreenChange(this);} PE( NE){if(onFullscreenChange==null){return;}onFullscreenChange(this);}final  KE=new List<n>(); QE( g){KE.add(new n(g,n.WB));} RE( g){KE.add(new n(g,n.UB));} SE( g){KE.add(new n(g,n.VB));}final  IE=new List<h.KeyboardEvent>(); TE( g){IE.add(g);} UE( g){IE.add(g);}final  JE=new List<h.MouseEvent>(); VE( g){JE.add(g);} WE( g){JE.add(g);} XE( g){JE.add(g);} YE( g){JE.add(g);g.preventDefault();} ZE( NE){if(iD==false){iD=true;}} start(){if(cD==false){h.document.onFullscreenError.listen(PE);h.document.onFullscreenChange.listen(OE);h.window.onTouchStart.listen(QE);h.window.onTouchEnd.listen(SE);h.window.onTouchMove.listen(RE);h.window.onKeyDown.listen(TE);h.window.onKeyUp.listen(UE);h.window.onResize.listen(ZE);h.window.onMouseMove.listen(XE);h.window.onMouseDown.listen(VE);h.window.onMouseUp.listen(WE);h.window.onMouseWheel.listen(YE);cD=true;}eD=false;LE=h.window.requestAnimationFrame(ME);}var HB;var onResize;var onFullscreenChange;var onPointerLockChange;var onTouchStart;var onTouchEnd;}class KC{final  v=new Map<int,u>();final  j;KC(this.j); kD( l, g){var i=new XB(g.client.x,g.client.y,0,0,j.dB,j.k);l.vC.add(i);} pD( l){l.changedTouches.forEach(( g){var i=new u(g.identifier);v[g.identifier]=i;kD(i,g);if(j.onTouchStart!=null){j.onTouchStart(j,i);}});} vD( l){l.changedTouches.forEach(( g){var i=v[g.identifier];v.remove(g.identifier);kD(i,g);if(j.onTouchEnd!=null){j.onTouchEnd(j,i);}});} DE( i){i.changedTouches.forEach(( g){var l=v[g.identifier];kD(l,g);});}}